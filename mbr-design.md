# DESIGN-设计

MBR-主引导记录  

标准MBR结构  

| 地址(D) | 描述 | 长度 |
| -- | -- | -- |
| 0 | 代码区 | 440 |
| 440 | 选用软盘标志 | 4 |
| 444 | 一般为空值; 0x0000 | 2 |
| 446 | 标准 MBR 分区表规划 | 64 |
| 510 | 55h | 1 |
| 511 | AAh | 1 |


> MBR是不属于任何一个操作系统，也不能用操作系统提供的磁盘操作命令来读取它，但可以通过命令来修改和重写。    

分区表项的结构

| 地址(D) | 描述 |
| -- | -- |
| 0 | 活动（80）或非活动分区（00） |
| 1 | [起始]磁头号 |
| 2 | [起始]扇区号低6位 ＋ 柱面号高2位 |
| 3 | [起始]柱面号低8位 |
| 4 | 分区类型 NTFS（07）FAT32（0B）扩展（0F）|
| 5 | [结束]磁头号 |
| 6 | [结束]扇区号低6位 ＋ 柱面号高2位 |
| 7 | [结束]柱面号低8位 |
| 8-B | 本分区之前已用扇区数 |
| C-F | 本分区大小 |


虽然我们可以远离分区结构自起操作系统。
但是在我们的文件系统设计出来之前，还是需要MBR来判断和加载进一步的引导程序。

我在这里做一个虚拟的EE分区作为我们的引导分区，因为我还没有确定我的文件系统。

分区表项的构成

我们制作一个200MB的c盘分区用来引导  
200MB = 200x2x1024扇  = 409600D = 64000H 反向 00 40 06  

C = 409600/16065 = 25D = 0x19  
H = 7975/63 = 126D = 0x7E  
S = 37D = 0x25  
最后加上起始位置得到7F2619  

| 地址(D) | 值(H) |
| -- | -- |
| 0 | 80 |
| 1 | 01 |
| 2 | 01 |
| 3 | 00 |
| 4 | EE |
| 5 | 7F |
| 6 | 26 |
| 7 | 19 |
| 8-B | 3F000000 |
| C-F | 00400600 |

注意这里的  
6位是 C[0-1]:00 + S[2-8]:100101  
7位是 C[2-10]  

分区表的label是DPT_FIRST  

其他
```nasm
    mov sp,0
```
由此看出我们的堆栈区域是 0xFFFF 向下 因为我们的引导很快就会跳出，并不担心他会污染到我们的引导区  

之后我们采用pio的方式加载C盘隐藏区的第一扇到0x7e00,然后跳转